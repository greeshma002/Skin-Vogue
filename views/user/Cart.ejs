<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
        integrity="sha512-xyz" crossorigin="anonymous" />
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
 
    <style>
        body {
          font-family: poppins;
            margin: 0;
            padding: 0;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #ff69b4;
            color: #fff;
        }

        .brand {
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .brand img {
            margin-right: 10px;
            height: 30px;
        }

        .navbar-links {
            display: flex;
            align-items: center;
        }

        .link {
            margin: 0 10px;
            color: #fff;
            text-decoration: none;
        }


        /* Media query for mobile screens */
        @media only screen and (max-width: 767px) {
            .navbar-links {
                display: none;
                /* Hide links on small screens */
            }

            .brand {
                font-size: 1.5em;
                /* Adjust the font size for the brand on small screens */
            }

            .link {
                display: none;
            }
        }
    </style>
</head>

<body>

    <div class="navbar">
        <div class="brand">
            <img src="/assets/img/logo.png" alt="Logo">
            <div><strong>SKINVOGUE</strong></div>
        </div>
        <div class="navbar-links">
            <a href="/" class="link">Home</a>
            <a href="/shop" class="link">Shop</a>
            
           
            <a href="/cartdetails" class="link"><i class="fas fa-shopping-cart"></i></a>
            <a href="/userprofile" class="link"><i class="fas fa-user"></i></a>
           
        </div>
    </div>


    <h6 class="ms-5">
        <a href="#" class="link">Home</a>
        <span class="text-white-50 mx-2"> > </span>
        <a href="#" class="link"><u>Shopping cart</u></a>
    </h6>
    </nav>
    <!-- Breadcrumb -->
    </div>
    </div>
    <!-- Heading -->
    </header>

</html>



<div class="d-flex">

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-10">

                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">Product</th>
                            <th scope="col" class="text-center">Quantity</th>
                            <th scope="col" class="text-center">Price</th>
                            <th scope="col" class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (cartdata && cartdata.product) { %>
                          <% cartdata.product.forEach(product => { %>
                            <tr>
                              <!-- Product details -->
                              <td>
                                <div class="d-flex">
                                  <img src="<%= product.image %>" class="border rounded me-3" style="width: 96px; height: 96px;" />
                                  <div>
                                    <a href="#" class="nav-link">
                                      <%= product.productName %> <br>
                                      <span>
                                        <% if (product.productQuantity > 0 && product.productQuantity >= product.quantity) { %>
                                          <strong style="color: green;">In stock</strong>
                                        <% } else { %>
                                          <strong style="color: red;">Out of stock</strong>
                                          <% totalPrice -= product.price * product.quantity; %>
                                        <% } %>
                                      </span>
                                      
                                      
                                    </a>
                                  </div>
                                </div>
                              </td>
                      
                              <!-- Quantity -->
                              <td class="text-center">
                                <div class="quantity-container">
                                  <% if (product.productQuantity > 0  ) { %>
                                    <button class="quantity-btn" onclick="updateQuantity('<%= product.productId %>', -1)">-</button>
                                    <text id="quantity-<%= product.productId %>" class="h6"><%= product.quantity %></text>
                                    <button class="quantity-btn" onclick="updateQuantity('<%= product.productId %>', 1)">+</button>
                                  <% } else { %>
                                    <button class="quantity-btn" disabled>-</button>
                                    <text id="quantity-<%= product.productId %>" class="h6"><%= product.quantity %></text>
                                    <button class="quantity-btn" disabled>+</button>
                                  <% } %>
                                </div>
                              </td>
                              <%= console.log(product.productQuantity) %>
                              <%=  console.log(product.productId)  %>
                           
                      
                              <!-- Price -->
                              <td class="text-center">
                                <div>
                                  <text class="h6">₹ <%= product.price %></text> <br />
                                  <small class="text-muted text-nowrap"> ₹<%= product.price %> / per item</small>
                                </div>
                              </td>
                      
                              <!-- Remove button -->
                              <td class="text-center">
                                <div class="float-md-end">
                                  <a href="/cartremove/<%= product.productId %>"><button class="btn btn-danger">Remove</button></a>
                                </div>
                              </td>
                            </tr>
                          <% }); %>
                      
                          <!-- Display the updated total price -->
                         
                        <% } else { %>
                          <tr>
                            <td colspan="4" class="text-center">Cart is empty</td>
                          </tr>
                        <% } %>
                      </tbody>
                      
                </table>
                </table>
            </div>
        </div>
    </div>


    <!-- Summary Section -->
    <div class="col col-lg-4 mt-5">
        <div class="d-flex flex-column align-items-center">
            <div class="card p-3" style="border-radius: 20px;">
                <div class="col-lg-12">
                    <div class="card mb-3 border shadow-0">
                        <div class="card-body">
                          <form id="couponForm" action="/applyCoupon" method="post">
                            <div class="form-group">
                              <label class="form-label">Have coupon?</label>
                              <div class="input-group">
                                <select class="form-control border" name="selectedCoupon">
                                  <option value="" >Select a coupon</option>
                                  <% 
                                    function isValidCoupon(coupon, totalPrice) {
                                      const minValue = coupon.minValue;
                                      const maxValue = coupon.maxValue;
                                      const isValid = calculateTotalPrice(cartdata) + totalPrice  >= minValue && calculateTotalPrice(cartdata) + totalPrice  <= maxValue;
                                     // console.log("Coupon:", coupon, "Total Price:", totalPrice, "Is Valid:", isValid);
                                       return isValid;
                                    }
            
                                    coupons.filter(coupon => isValidCoupon(coupon, totalPrice)).forEach(coupon => { 
                                      
                                  %>
                                    <option value="<%= coupon.couponCode %>"><%= coupon.couponCode %></option>
                                  <% }); %> 
                                </select>
                                <a href=""><button id="couponApply" type="submit" class="btn btn-light border">Apply</button></a>
                              </div>
                            </div>
                          </form>
                          
                          <!-- Include jQuery library if not already included -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>
  $(document).ready(function() {
    // Disable the select and apply button if a coupon is already applied
    if ($('select[name="selectedCoupon"]').val() !== "") {
      disableCouponField();
    }

    // Event handler for applying the coupon
    $('#couponForm').submit(function(event) {
      event.preventDefault(); // Prevent the form from submitting

      // Check if a coupon is selected
      var selectedCoupon = $('select[name="selectedCoupon"]').val();
      if (selectedCoupon !== "") {
        // Disable the select and apply button
        disableCouponField();
        
        // Perform any additional actions you want when a coupon is applied
        // For example, you can make an AJAX request to apply the coupon on the server
        // and update the total price display.

        // For now, I'll just log a message
        console.log("Coupon applied:", selectedCoupon);
      }
    });

    // Function to disable the select coupon field and apply button
    function disableCouponField() {
      $('select[name="selectedCoupon"]').prop('disabled', true);
      $('#couponApply').prop('disabled', true);
    }
  });
</script>

                          
                          
                        </div>
                    </div>
                   
                    <div class="card shadow-0 border">
                        <div class="card-body">
                            <div style="display: flex; flex-direction: column;" class="d-flex justify-content-between">

                             

                                <p>Actual Price: ₹
                                  <span id="Actualprice"><%= calculateTotalPrice(cartdata) + totalPrice  %></span>
                                </p>
                              
                                <p>Discounted Price: 
                                  <span id="discountedPrice"></span>
                                </p>

                               
                                <p>Total Price: ₹
                                  <span id="totalPrice"><%=calculateTotalPrice(cartdata) + totalPrice %></span>
                                </p>
                            </div>


                            <div class="mt-3">
                                <a href="/checkout" id="CheckOut" class="btn btn-success w-100 shadow-0 mb-2"> Make Purchase </a>
                                <a href="/shop" class="btn btn-light w-100 border mt-2"> Back to shop </a>
                                <% if (err) {%>
                                    <p style="color: red;"> Remove the Out of Stock Products </p>
                                <%} %>
                            </div>
                        </div>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>

<script>
    const couponApply = document.getElementById("couponApply")
    couponApply.addEventListener("click",()=> {
      console.log("hii");
      Toastify({
          text: "Coupon Applied!!!",
          duration: 600,
          destination: "https://github.com/apvarun/toastify-js",
          newWindow: true,
          close: true,
          gravity: "top", // top or bottom
          position: "right", // left, center or right
          stopOnFocus: true, // Prevents dismissing of toast on hover
          style: {
            background: " #228B22  ",
          },
          onClick: function(){
            alert("Toast clicked!");
          }
        }).showToast();
    })
    </script>




<!-- <script>
    const couponApply = document.getElementById("couponApply")
    couponApply.addEventListener("click",()=> {
      console.log("hii");
      Toastify({
          text: "Coupon applied",
          duration: 600,
          destination: "https://github.com/apvarun/toastify-js",
          newWindow: true,
          close: true,
          gravity: "top", // top or bottom
          position: "right", // left, center or right
          stopOnFocus: true, // Prevents dismissing of toast on hover
          style: {
            background: " #green  ",
          },
          onClick: function(){
            alert("Toast clicked!");
          }
        }).showToast();
    })
    </script> -->





<!-- Recommended -->

<!-- footer section -->

<!-- footer section -->
<script>

const CheckOut=document.getElementById('CheckOut')
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('form');

        form.addEventListener('submit', function (event) {
            event.preventDefault();

            // Get the selected coupon code
            const selectedCoupon = form.querySelector('[name="selectedCoupon"]').value;

            fetch('/applyCoupon', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ selectedCoupon }),
            })
            .then(response => response.json())
            .then(data => {
              console.log(data);
              let discount=data.totalPrice-data.discountedPrice
                
               
                const totalPriceElement = document.getElementById('totalPrice');
                const discountedPriceElement = document.getElementById('discountedPrice');
                const Actualprice = document.getElementById('Actualprice')
                CheckOut.href=`/checkout?id=${data.id}`
                
                const updatedTotalPrice = data.discountedPrice || data.totalPrice ;
                
                totalPriceElement.textContent = `${updatedTotalPrice}`;
               
                discountedPriceElement.value = data.discountedPrice || '';
                discountedPriceElement.innerText='₹ '+discount   
            })
            .catch(error => {
                console.error('Error applying coupon:', error);
            });
        });
    });



    function updateQuantity(productId,change) { 

        const totalPrice = document.getElementById('totalPrice');
        const quantityTextBox = document.getElementById(`quantity-${productId}`);
        const existingQuantity = Number(quantityTextBox.innerText);
        const newQuantity = existingQuantity + change;
        console.log(totalPrice);
        console.log(existingQuantity);
        console.log(newQuantity);

        if (newQuantity < 1) return;
        if (newQuantity > 9) return alert("You cannot purchase more than 9");


        fetch (`/updateQuantity/${productId}`,  { 
            method: 'PUT', 
            body: JSON.stringify({
                quantity: newQuantity
            }),
            headers: {
                "Content-Type": "application/json"
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.message === "success") {
                totalPrice.innerText = data.totalPrice;
                Actualprice.innerText = data.totalPrice
                quantityTextBox.innerText = newQuantity;
            } else {
                alert(data.message);
            }
        })
        .catch(err => alert("an error occured"));
    }
</script>


<!-- Add the SweetAlert script tag to your HTML file -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
    integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
    crossorigin="anonymous"></script>
</body>

</html>

